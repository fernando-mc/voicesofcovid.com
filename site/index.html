<!DOCTYPE html>
<html lang="en">

<head>
  <title>Voices of COVID-19</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./custom.css">
  
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.4/dist/semantic.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.4/dist/semantic.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.1.3/howler.js"></script> -->
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=es6,Array.prototype.includes,CustomEvent,Object.entries,Object.values,URL"></script>
  <script src="https://unpkg.com/plyr@3"></script>
  

  <style>
    .card {
      margin-top: 10px;
    }

    body {
      background-color: #373E58;
    }

    .main-box {
      margin-top: 5rem;
    }

    body>.container {
      padding: 24px;
      background-color: #373E58;
    }

    .hits-box {
      padding: 1px 14px 12px;
    }


  </style>
</head>

<body>
  <div class="ui top fixed stackable menu">
    <div class="item">
      <h2>Voices of COVID-19</h2>
    </div>
  </div>

  <div class="ui container main-box">
    <div class="ui grid">
        <div class="row mobile only">
            <br>
            <br>
        </div>
    </div>
    <div class="submit-box" id="form-div">
      <div class="ui brown top attached segment">
        <h3>  Share your story:</h3>
      </div>
      <form class="ui equal width attached segment form" id="submission">
        <div class="four fields">
          <div class="field">
            <label for="first_name">First name:</label>
            <input type="text" class="form-control" id="first_name" placeholder="Jasmine" name="first_name">
          </div>
          <div class="field">
            <label for="job">Job:</label>
            <input type="text" class="form-control" id="job" placeholder="Nurse" name="job">
          </div>
          <div class="field">
            <label for="description">Description:</label>
            <input type="text" class="form-control" id="description" placeholder="What's your story?" name="description">
          </div>
          <div class="field">
            <label for="language">Language:</label>
            <select class="ui selection dropdown" id="gender">
              <option value="">Select language</option>
              <option value="english">English</option>
              <option value="espanol">Espa√±ol</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="ui two column centered grid">
          <div class="one column row">
            <div class="ui action input">
              <input id="voicefileupload" type="text" placeholder="Upload your story" readonly>
              <input id="voicefile" type="file">
              <div id="voicefileupload" class="ui icon button">
                <i id="voicefileuploadicon" class="upload icon"></i>
              </div>
            </div>
          </div>
        </div>
        <br>
        <div class="ui two column centered grid">
          <div class="one column row">
            <div class="right floated item">
              <div class="g-recaptcha" data-sitekey="6LfBV-YUAAAAAC2F4BdtYjZB72gCuP-aFRd0F_N7"></div>
            </div>
          </div>
          <div class="one column row">
            <button type="submit" class="ui huge blue button">Submit</button>
            <div class="ui error message">
              <div id='error-message' style="color: red"></div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="ui horizontal divider" id="hr-divider">
      Or
    </div>

    <div class="rates-box">
      <div class="ui purple top attached segment">
        <div class="ui stackable grid">
          <div class="four wide column">
            <h3>Listen to other stories:</h3>
          </div>
        </div>
      </div>

      
      <div class="ui attached segment">
        <br>
        <div class="ui three column grid">
          <div class="ui cards" id="voices">

          </div>

        <br>
      </div>

    </div>
  </div>
  <br>

</body>

</html>

<script>
  $("#voicefileuploadicon").click(function() {
    $(this).parent().parent().find("input:file").click();
  });
  $("#voicefileupload").click(function() {
    $(this).parent().find("input:file").click();
  });

  $('input:file', '.ui.action.input')
    .on('change', function(e) {
      var name = e.target.files[0].name;
      $('input:text', $(e.target).parent()).val(name);
    });
  
  const optionalFields = ['first_name', 'job', 'description', 'language'];
  var API_URL = 'https://REPLACE_ME.execute-api.us-east-1.amazonaws.com/dev/validate';

  var errorDiv = document.getElementById('error-message')

  $('#submission').submit(function (event) {
    event.preventDefault();

    const captchtaResponse = grecaptcha.getResponse() || false

    if (!captchtaResponse) {
      errorDiv.innerHTML = 'Complete the Captcha please!'
      return false
    }

    var post_data = {
      captcha: captchtaResponse
    };
      
    for (i = 0; i < optionalFields.length; i++) {
      if ($('#' + optionalFields[i]).val()) {
        post_data[optionalFields[i]] = $('#' + optionalFields[i]).val()
      }
    }

    $.ajax({
      type: 'POST',
      url: API_URL,
      dataType: 'json',
      crossDomain: true,
      contentType: 'application/json',
      data: JSON.stringify(post_data),
      success: function (responseData, textStatus, jqXHR) {
        console.log(responseData);
        if (responseData.statusCode == '200') {
          console.log(responseData);
          document.getElementById("form-div").innerHTML = "<p> Your story is being uploaded now</p>"
          document.getElementById("hr-divider").innerHTML = ""
          var voice_file = document.getElementById("voicefile").files[0]
          let formData = new FormData();
          formData.append("voice", voice_file);
          fetch(responseData.url, {method: "POST", body: formData});
        };
        if (responseData.message == 'Captcha Invalid') {
          console.log('The Captcha failed. Please try again!')
        };
      },
    })
  })

  

testVoices = [
  {
    id: 'm1-01-trailer.mp3',
    name : 'Fernando',
    job : 'Nurse',
    description : 'super good at nursing',
    language : 'en',
    url: 'https://s3-us-west-2.amazonaws.com/voicesofcovid.com/m1-01-trailer.mp3'
  },
  {
    id: '178tyugadsih',
    name : 'Fernando',
    job : 'Nurse',
    description : 'super good at nursing',
    language : 'en',
    url: 'https://cdn.plyr.io/static/demo/Kishi_Bashi_-_It_All_Began_With_a_Burst.mp3'
  }
]

function writeVoices(voices){
  let finalCards = ''
  for (i = 0; i < voices.length; i++){
    finalCards += `
      <div class="card">
        <div class="content">
          <div class="header">
            ` + voices[i].name + ` 
          </div>
          <div class="meta">
            ` + voices[i].job + ` | ` + voices[i].language + `
          </div>
          <div class="description">
            ` + voices[i].description + `
          </div>
        </div>
        <audio crossorigin playsinline class="player" controls>
            <source src="` + voices[i].url + `" type="audio/mp3">
          </audio>
        <div class="extra content">
          
        </div>
    </div>
      `;
    }
  document.getElementById("voices").innerHTML += finalCards
}

writeVoices(testVoices)

// Change "{}" to your options:
// https://github.com/sampotts/plyr/#options
const players = Array.from(document.getElementsByClassName("extra content audioplayer")).map(p => new Plyr(p));

</script>